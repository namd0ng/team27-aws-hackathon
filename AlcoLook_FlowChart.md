# AlcoLook 서비스 플로우차트

## 전체 서비스 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                        AlcoLook 앱 시작                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    메인 화면 (MainActivity)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │ 실시간 카메라 │  │ 사진 업로드  │  │ 배치 분석   │  │ 테스트  │ │
│  │   분석      │  │    분석     │  │    도구     │  │  도구   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
└─────┬───────────────┬───────────────┬───────────────┬───────────┘
      │               │               │               │
      ▼               ▼               ▼               ▼
```

## 1. 실시간 카메라 분석 플로우

```
┌─────────────────────┐
│  CameraScreen 시작   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   카메라 권한 확인    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐     거부     ┌─────────────────────┐
│   권한 허용 여부?    │ ──────────► │   권한 요청 화면     │
└─────────┬───────────┘             └─────────────────────┘
          │ 허용
          ▼
┌─────────────────────┐
│  카메라 프리뷰 시작  │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   실시간 얼굴 감지   │ ◄──────────┐
│ (DrunkDetectionService)│           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│  AWS Rekognition    │           │
│    API 호출         │           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│   얼굴 특징 분석     │           │
│ • 눈 상태 (열림/감김) │           │
│ • 입 상태 (열림/닫힘) │           │
│ • 표정 분석         │           │
│ • 얼굴 기울기       │           │
│ • 얼굴 홍조         │           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│   음주도 계산        │           │
│ (0-100% 점수화)     │           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│  FaceDetectionOverlay│           │
│ • 얼굴 박스 표시     │           │
│ • 음주도 퍼센트      │           │
│ • 색상 구분         │           │
│   (녹색/노랑/빨강)   │           │
└─────────┬───────────┘           │
          │                       │
          └───────────────────────┘
```

## 2. 사진 업로드 분석 플로우

```
┌─────────────────────┐
│ PhotoUploadScreen   │
│      시작           │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   갤러리에서        │
│   사진 선택         │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   이미지 로드 및     │
│   화면 표시         │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  "분석하기" 버튼     │
│     클릭            │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│PhotoDrunkDetectionService│
│      호출           │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   이미지 압축        │
│ (JPEG, 80% 품질)    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ AWS Rekognition     │
│ DetectFaces API     │
│ (ALL attributes)    │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   다중 얼굴 처리     │
│ • 각 얼굴별 분석     │
│ • 개별 음주도 계산   │
│ • 평균 음주도 산출   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ FaceDetectionOverlay │
│ • 모든 얼굴 박스     │
│ • 개별 음주도 표시   │
│ • 정확한 좌표 매핑   │
└─────────────────────┘
```

## 3. 음주 감지 알고리즘 상세

```
┌─────────────────────┐
│    얼굴 특징 입력    │
│   (FaceDetail)      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   홍조 분석 (NEW!)   │
│ • 얼굴 랜드마크      │
│ • 감정 상태         │
│ • 얼굴 밝기         │
│ → 최대 30점         │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│     눈 상태 분석     │
│ • 감김: +40점        │
│ • 불확실: +20점      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│     입 상태 분석     │
│ • 벌어짐: +25점      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│     표정 분석       │
│ • 혼란: +40%점수     │
│ • 놀람: +30%점수     │
│ • 혐오: +35%점수     │
│ • 슬픔: +25%점수     │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   얼굴 기울기 분석   │
│ • Roll > 15°: +20점  │
│ • Pitch > 20°: +15점 │
│ • Yaw > 25°: +15점   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   점수 증폭 및 정규화 │
│ • 사진: 2배 증폭     │
│ • 실시간: 1.5배 증폭 │
│ • 0-100% 범위 제한   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│    최종 음주도       │
│   및 메시지 생성     │
└─────────────────────┘
```

## 4. 배치 분석 도구 플로우

```
┌─────────────────────┐
│  BatchImageAnalyzer  │
│       시작          │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│ drunk-images 폴더    │
│    스캔             │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  이미지 파일 필터링  │
│ (.jpg, .jpeg, .png) │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│   각 이미지별       │ ◄──────────┐
│   순차 분석         │           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│PhotoDrunkDetectionService│       │
│      호출           │           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│   결과 수집 및       │           │
│   통계 계산         │           │
└─────────┬───────────┘           │
          │                       │
          ▼                       │
┌─────────────────────┐           │
│   다음 이미지?       │ ──────────┘
└─────────┬───────────┘
          │ 완료
          ▼
┌─────────────────────┐
│   최종 통계 리포트   │
│ • 평균 음주도        │
│ • 개별 결과         │
└─────────────────────┘
```

## 5. 테스트 모드 플로우

```
┌─────────────────────┐
│   AwsConfig 확인     │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      Yes     ┌─────────────────────┐
│  TEST_MODE = true?  │ ──────────► │   랜덤 값 생성       │
└─────────┬───────────┘             │  (30-70% 범위)      │
          │ No                      └─────────────────────┘
          ▼
┌─────────────────────┐
│  AWS 자격증명 확인   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      실패     ┌─────────────────────┐
│   AWS 연결 시도     │ ──────────► │   Fallback 모드      │
└─────────┬───────────┘             │  (랜덤 값 사용)      │
          │ 성공                    └─────────────────────┘
          ▼
┌─────────────────────┐
│  실제 AWS API 호출   │
└─────────────────────┘
```

## 6. 데이터 흐름

```
Input: 이미지/비디오
    ↓
AWS Rekognition API
    ↓
FaceDetail 객체
    ↓
음주 감지 알고리즘
    ↓
DrunkDetectionResult
    ↓
UI 표시 (박스 + 퍼센트)
```

## 주요 컴포넌트

- **MainActivity**: 메인 네비게이션
- **CameraScreen**: 실시간 카메라 분석
- **PhotoUploadScreen**: 사진 업로드 분석
- **DrunkDetectionService**: 실시간 음주 감지
- **PhotoDrunkDetectionService**: 사진 음주 감지
- **FaceDetectionOverlay**: 얼굴 박스 UI
- **BatchImageAnalyzer**: 배치 분석 도구
- **TestDatasetEvaluator**: 테스트 평가 도구
- **AwsConfig**: AWS 설정 관리
